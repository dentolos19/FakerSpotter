@page "/room/3"

<RoomPanel RoomName="@string.Format("Room 3: Spot the fake news! ({0}/5)", QuestionsAnswered)" IsCompleted="UserSettings.IsRoomThreeCompleted" IsLocked="!UserSettings.IsRoomTwoCompleted" NextRoomEndpoint="finish" PreviousRoomEndpoint="room2">
    <RoomContent>
        @QuestionPanel
    </RoomContent>
</RoomPanel>

@code
{

    [Inject] private IAnalytics Analytics { get; set; }
    [Inject] private NavigationManager NavigationManager { get; set; }
    [Inject] private HttpClient HttpClient { get; set; }
    [Inject] private Random Random { get; set; }

    private int Points { get; set; } = 500;
    private int QuestionsAnswered { get; set; }
    private RenderFragment QuestionPanel { get; set; }

    protected override void OnInitialized()
    {
        NextQuestion();
    }

    private void OnQuestionCompleted(bool answeredCorrectly)
    {
        if (answeredCorrectly)
        {
            QuestionsAnswered++;
        }
        else
        {
            QuestionsAnswered = 0;
            Points -= Random.Next(0, 100);
            if (Points < 100)
                NextRoom();
        }
        if (QuestionsAnswered < 5)
        {
            NextQuestion();
        }
        else
        {
            NextRoom();
        }
    }

    private RenderFragment BuildQuestion(NewsQuestion question)
    {
        return builder =>
        {
            builder.OpenComponent(0, typeof(NewsPanel));
            builder.AddAttribute(1, "Question", question);
            builder.AddAttribute(2, "OnComplete", EventCallback.Factory.Create<bool>(this, OnQuestionCompleted));
            builder.CloseComponent();
        };
    }

    private void NextQuestion()
    {
        var question = GlobalVariables.NewsQuestions[Random.Next(GlobalVariables.NewsQuestions.Length)];
        QuestionPanel = BuildQuestion(question);
    }

    private void NextRoom()
    {
        Analytics.TrackEvent("completed_room3", Points);
        UserSettings.PointsAccumulated += Points;
        UserSettings.IsRoomThreeCompleted = true;
        NavigationManager.NavigateTo("finish");
    }

}